<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="image">
	<resultMap id="TagImageResultDTO" type="TagImageDTO">
		<id column="id" jdbcType="BIGINT" property="id" />
		<result column="fileName" jdbcType="VARCHAR" property="fileName" />
	</resultMap>
	
	<sql id = "getTagImageCondition">
		from image_inf i
		<if test="searchDto.getTagId() != null">
			inner join tag_image ti on i.id = ti.imageId 
			inner join tag t on t.id = ti.tagId and t.id = #{seachDto.tagId}
		</if>
		<if test="searchDto.getTagName() != null and searchDto.getTagName() != ''">
			inner join tag_image tii on i.id = tii.imageId 
			inner join tag tt on tt.id = tii.tagId and lower(tt.name) like '%${searchDto.tagName}%'
		</if>
		where i.type = 0 and i.status != 1
	</sql>
	
	<select id="getTagImageTotalNum" parameterType="Map" resultType="Long">
		select count(i.id)
		<include refid="getTagImageCondition" />
	</select>

	<select id="getTagImageList" parameterType="Map" resultMap="TagImageResultDTO" >
		select i.*
		<include refid="getTagImageCondition" />
		limit ${(p.pageNum - 1) * p.numPerPage}, ${p.numPerPage}
	</select>
	
	<select id=getTagNameListByImageId parameterType="Long" resultType="String">
		select t.name from tag t inner join tag_image ti on t.id = ti.tagId
		where ti.imageId = #{imageId}
	</select>
	
	<select id="getById" parameterType="Integer" resultType="TagDTO">
		select * from tag where id = #{tagId}
	</select>
	
	<insert id="insertTag" useGeneratedKeys="true" keyProperty="id" parameterType="TagDTO">
		INSERT INTO tag(name, status, tagOrder) 
		VALUE (#{name}, #{status}, #{tagOrder}) 
  	</insert>
  	
  	<update id="deleteByIds" parameterType="Map">
		update tag set status = 2 where id in (${ids})
	</update>
  	
  	<update id="update" parameterType="TagDTO">
		update tag set status = #{status}, name = #{name}, tagOrder = #{tagOrder} where id = #{id}
	</update>
</mapper>